<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Donut Tracker</title>
    <meta name="theme-color" content="#9370DB"> <!-- MediumPurple - a core lavender shade -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/donut/manifest.json">
    <link rel="apple-touch-icon" href="/donut/icons/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap'); /* Added Bangers font */
        
        body {
            font-family: 'Nunito', Arial, sans-serif;
            /* Brighter, playful gradient background */
            background: linear-gradient(160deg, #E6E6FA 0%, #D8BFD8 50%, #B19CD9 100%); /* Soft lavender gradient */
            animation: rainbowBg 20s linear infinite;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            padding: 20px;
            cursor: auto;
        }

        /* Floating background elements - more scattered and prominent */
        .floating-element {
            position: absolute;
            opacity: 0.8; /* Slightly more opaque */
            animation: floatAndRotate 25s infinite ease-in-out; /* Slower, more graceful animation */
            z-index: 0;
        }

        /* Adjusted positions and sizes for more scattering */
        .floating-element:nth-child(1) { top: 5%; left: 5%; width: 120px; animation-delay: 0s; font-size: 5em; animation: floatBounce 6s ease-in-out infinite; }
        .floating-element:nth-child(2) { top: 15%; right: 10%; width: 80px; animation-delay: 3s; }
        .floating-element:nth-child(3) { bottom: 10%; left: 15%; width: 120px; animation-delay: 6s; }
        .floating-element:nth-child(4) { top: 30%; left: 2%; width: 90px; animation-delay: 9s; }
        .floating-element:nth-child(5) { bottom: 5%; right: 5%; width: 110px; animation-delay: 12s; }
        .floating-element:nth-child(6) { top: 25%; left: 40%; width: 70px; animation-delay: 15s; }
        .floating-element:nth-child(7) { bottom: 20%; right: 18%; width: 95px; animation-delay: 18s; }
        .floating-element:nth-child(8) { top: 50%; left: 30%; width: 85px; animation-delay: 21s; }
        .floating-element:nth-child(9) { top: 10%; right: 25%; width: 105px; animation-delay: 24s; }
        .floating-element:nth-child(10) { bottom: 15%; left: 45%; width: 75px; animation-delay: 2s; }
        .floating-element:nth-child(11) { top: 60%; right: 8%; width: 100px; animation-delay: 7s; }
        .floating-element:nth-child(12) { top: 40%; left: 10%; width: 90px; animation-delay: 13s; }
        .floating-element:nth-child(13) { bottom: 30%; left: 5%; width: 115px; animation-delay: 19s; }
        .floating-element:nth-child(14) { top: 5%; left: 60%; width: 80px; animation-delay: 22s; }
        .floating-element:nth-child(15) { bottom: 25%; right: 30%; width: 105px; animation-delay: 5s; }
        .floating-element:nth-child(16) { top: 12%; left: 70%; width: 90px; animation-delay: 1s; }
        .floating-element:nth-child(17) { bottom: 8%; left: 75%; width: 100px; animation-delay: 4s; }
        .floating-element:nth-child(18) { top: 45%; right: 2%; width: 85px; animation-delay: 10s; }
        .floating-element:nth-child(19) { top: 20%; right: 40%; width: 110px; animation-delay: 16s; }
        .floating-element:nth-child(20) { bottom: 40%; left: 25%; width: 70px; animation-delay: 20s; }


        @keyframes floatBounce {
            0%, 100% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-40px) rotate(5deg) scale(1.1); }
            50% { transform: translateY(0) rotate(0deg) scale(1); }
            75% { transform: translateY(30px) rotate(-5deg) scale(1.1); }
        }
        
        @keyframes rainbowBg {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        .donut-bg {
            /* Playful donut-themed container */
            background-color: white;
            position: relative;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 10px dotted #9370DB; /* Dotted lavender border */
        }
        .donut-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3); /* Lighter, more transparent overlay */
            z-index: 0;
        }
        .donut-bg > div {
            position: relative;
            z-index: 1;
        }

        .donut-card {
            transition: all 0.4s cubic-bezier(.25,.8,.25,1.5);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-radius: 20px;
            border: none;
            background: white;
            border-left: 10px solid #9370DB;
        }
        
        .donut-card:hover {
            /* Removed transform: translateY and rotate properties */
            transform: scale(1.03); /* Keep only the scale effect */
            box-shadow: 0 25px 40px rgba(0,0,0,0.25);
        }
        
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        button {
            border-radius: 20px;
            padding: 15px 30px;
            font-size: 1.6rem;
            font-weight: 800;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            box-shadow: 0 8px 0 #9370DB, 0 15px 20px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            background: #FFD166;
            color: #333;
            border: none;
            letter-spacing: 1px;
            font-family: 'Comic Sans MS', arial;
        }
        button:hover {
            transform: scale(1.2) rotate(10deg);
            box-shadow: 0 12px 20px rgba(0,0,0,0.4);
            background: linear-gradient(45deg, #BA55D3, #8A2BE2); /* Reverse gradient on hover */
        }
        
        @keyframes floating {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(8deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }

        /* Custom colors for a lavender-themed palette */
        .text-primary-heading { 
            color: #4B0082; /* Indigo - deep purple */
            font-family: 'Nunito', Arial, sans-serif;
            font-weight: 900;
        } 
        .text-secondary-text { color: #6A5ACD; } /* SlateBlue - vibrant purple */
        .bg-form-background { background-color: #DDA0DD; border: 4px solid #BA55D3; } /* Plum with MediumOrchid border */
        .text-accent-pink { color: #9370DB; } /* MediumPurple - playful accent */
        .text-accent-orange { color: #FF8C00; } /* DarkOrange - bright accent */
        .bg-card-light-pink { background-color: #E6E6FA; } /* Lavender */
        .bg-card-light-purple { background-color: #E0BBE4; } /* Thistle */
        .bg-card-light-yellow { background-color: #FFFACD; } /* LemonChiffon */
        .border-input { border-color: #BA55D3; border-width: 3px; } /* MediumOrchid, thicker border */
        .focus-border-input { border-color: #8A2BE2; }
        .bg-purple-600 { background: linear-gradient(45deg, #8A2BE2, #BA55D3); }
        .hover\:bg-purple-800:hover { background: linear-gradient(45deg, #BA55D3, #8A2BE2); }
        .bg-pink-100 { background-color: var(--bg-table-header, #4B0082); }
        .border-purple-200 { border-color: var(--border-table-row, #DDA0DD); border-width: 2px; }
        .hover\:bg-purple-100:hover { background-color: var(--hover-table-row, #F0E6FA); }
        .text-purple-500 { 
            color: var(--text-primary-heading, #4B0082); 
            font-family: 'Nunito', Arial, sans-serif;
            font-weight: 800;
        }
        .text-green-600 { color: var(--text-summary-green, #6B8E23); }
        .text-blue-600 { color: var(--text-summary-blue, #4682B4); }
        .border-pink-100 { border-color: var(--border-financial-table, #E0BBE4); border-width: 2px; }
        .hover\:bg-pink-50:hover { background-color: var(--hover-financial-table, #F0E6FA); }
        .border-pink-300 { border-color: var(--border-financial-table, #E0BBE4); border-width: 2px; }
        .focus\:border-pink-500:focus { border-color: var(--focus-border-input, #8A2BE2); }

        /* Specific styles for select inputs to match the theme */
        #flavor, #topping, #quantity, #historyDateFilter, #financialHistoryDateFilter, #dailyFinancialHistoryDateFilter, #monthlyFinancialMonthFilter, #monthlyFinancialYearFilter {
            border-width: 3px;
            border-radius: 1rem;
            padding: 0.6rem 0.8rem;
            font-size: 1.1rem;
            color: #6A5ACD; /* SlateBlue for text */
            background-color: #FFFFFF;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238A2BE2%22%20d%3D%22M287%2C197.3L159.3%2C69.6c-3.2-3.2-8.4-3.2-11.6%2C0L5.4%2C197.3c-3.2%2C3.2-3.2%2C8.4%2C0%2C11.6l11.6%2C11.6c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l120.7-120.7l120.7%2C120.7c3.2%2C3.2%2C8.4%2C3.2%2C11.6%2C0l11.6-11.6C290.2%2C205.7%2C290.2%2C200.5%2C287%2C197.3z%22%2F%3E%3C%2Fsvg%3E'); /* BlueViolet custom arrow */
            background-repeat: no-repeat;
            background-position: right 0.8em top 50%;
            background-size: 0.7em auto;
        }
        #flavor:focus, #topping:focus, #quantity:focus, #historyDateFilter:focus, #financialHistoryDateFilter:focus, #dailyFinancialHistoryDateFilter:focus, #monthlyFinancialMonthFilter:focus, #monthlyFinancialYearFilter:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.4); /* BlueViolet glow on focus */
        }

        /* Table specific styles for a cuter look */
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
        thead th {
            font-family: 'Nunito', Arial, sans-serif;
            font-weight: 800;
            font-size: 1.2rem;
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            /* Added styles for purple background */
            background-color: #8A2BE2; /* BlueViolet */
            background: linear-gradient(45deg, #8A2BE2, #BA55D3); /* Gradient from BlueViolet to MediumOrchid */
            /* Added border-radius for rounded corners */
            border-radius: 1.5rem 1.5rem 0 0; /* Top-left, Top-right, Bottom-right, Bottom-left */
        }
        tbody tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.7);
        }
        tbody tr:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.9);
        }
        tbody tr:hover {
            background-color: #F0E6FA; /* Lavender (Thistle) light on hover */
            transform: scale(1.01);
            transition: all 0.2s ease-in-out;
        }
        .remove-button {
            background: #FFD166;
            border: 2px solid #FF8C00;
            color: #4B0082;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-family: 'Comic Sans MS', arial;
            box-shadow: 0 4px 0 #FF8C00;
            font-size: 0.9rem;
        }
        .remove-button:hover {
            transform: scale(1.05);
            background: #FF8C00;
            color: white;
        }

        /* Styles for details/summary elements */
        details {
            margin-bottom: 1rem;
            border: 1px solid #DDA0DD;
            border-radius: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            overflow: hidden; /* Ensures rounded corners apply to content */
        }

        summary {
            display: block; /* Ensures it takes full width */
            padding: 1rem;
            background-color: #E0BBE4; /* Thistle */
            color: #4B0082; /* Indigo */
            font-weight: bold;
            cursor: pointer;
            outline: none;
            border-bottom: 1px solid #DDA0DD;
            position: relative;
            padding-left: 2.5rem; /* Space for the arrow */
        }

        summary::-webkit-details-marker {
            display: none; /* Hide default arrow */
        }

        summary::before {
            content: 'â–¶'; /* Custom arrow */
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
        }

        details[open] > summary::before {
            transform: translateY(-50%) rotate(90deg); /* Rotate arrow when open */
        }

        details[open] > summary {
            border-bottom: 1px solid #DDA0DD; /* Keep border when open */
        }

        details .table-container {
            padding: 0.5rem; /* Padding inside the details content */
        }

        details table {
            width: 100%; /* Ensure table inside details takes full width */
            border-radius: 0; /* Remove outer border radius for inner table */
            box-shadow: none; /* Remove outer shadow for inner table */
        }
        details table thead {
            display: table-header-group; /* Show headers by default in desktop */
        }
        details table tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.5); /* Restore row borders */
        }
        details table tbody tr:last-child {
            border-bottom: none; /* No border on last row */
        }

        /* Kid-friendly header styles */
        .kid-friendly-header {
            font-family: 'Bangers', Nunito; /* Kid-friendly font */
            color: #8A2BE2; /* BlueViolet - a vibrant purple */
            text-shadow: 
                -2px -2px 0 #FFD700,  /* Gold outline */
                2px -2px 0 #FFD700,
                -2px 2px 0 #FFD700,
                2px 2px 0 #FFD700,
                4px 4px 0 #BA55D3; /* MediumOrchid deeper shadow */
            letter-spacing: 2px;
            line-height: 1.2;
            animation: bounceIn 1s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        /* Mobile-specific styles (max-width: 768px) */
        @media (max-width: 768px) {
            body {
                padding: 10px; /* Reduce overall padding */
            }

            .donut-bg {
                border-width: 5px; /* Thinner border on mobile */
                border-radius: 20px;
                padding: 15px;
            }

            /* Smaller font sizes for main section titles */
            .bg-white > h2.text-3xl {
                font-size: 1.5rem; /* Adjusted for mobile */
            }
            .bg-form-background > h2.text-3xl {
                font-size: 1.5rem; /* Adjusted for mobile */
            }
            .grid > div > h2.text-3xl {
                font-size: 1.5rem; /* Adjusted for mobile */
            }


            .text-xl { font-size: 1.1rem; }
            .text-lg { font-size: 1rem; }
            .text-base { font-size: 0.9rem; }
            .text-sm { font-size: 0.8rem; }

            .text-center.mb-10 {
                margin-bottom: 1.5rem;
            }

            /* Smaller main title on mobile */
            h1.kid-friendly-header {
                font-size: 2.2rem !important; /* Smaller main title for mobile */
                text-shadow: 
                    -1px -1px 0 #FFD700,  /* Gold outline */
                    1px -1px 0 #FFD700,
                    -1px 1px 0 #FFD700,
                    1px 1px 0 #FFD700,
                    2px 2px 0 #BA55D3; /* MediumOrchid deeper shadow */
            }
            p.tracking-wide {
                font-size: 1rem !important;
            }

            .bg-form-background {
                padding: 1rem;
            }

            .donut-card {
                padding: 0.75rem;
                border-left-width: 5px; /* Thinner border for cards */
            }

            #flavor, #topping, #quantity, #historyDateFilter, #financialHistoryDateFilter, #dailyFinancialHistoryDateFilter, #monthlyFinancialMonthFilter, #monthlyFinancialYearFilter {
                font-size: 0.9rem;
                padding: 0.4rem 0.6rem;
                border-width: 2px;
                border-radius: 0.75rem;
            }

            button {
                padding: 10px 20px;
                font-size: 1.2rem;
                border-radius: 15px;
                box-shadow: 0 6px 0 #9370DB, 0 10px 15px rgba(0,0,0,0.2);
            }

            /* Responsive Table Styles for Mobile */
            .overflow-x-auto table {
                border: 0; /* Remove table border */
                box-shadow: none; /* Remove table shadow */
            }

            .overflow-x-auto table thead {
                display: none; /* Hide table headers on mobile */
            }

            .overflow-x-auto table tr {
                display: block; /* Make each row a block element */
                margin-bottom: 1rem; /* Space between rows */
                border: 1px solid #DDA0DD; /* Add a border to each "card" row */
                border-radius: 1rem; /* Rounded corners for each row */
                background-color: rgba(255, 255, 255, 0.9); /* Consistent background */
                box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Subtle shadow for each row */
            }

            .overflow-x-auto table td {
                display: block; /* Make each cell a block element */
                text-align: right; /* Align content to the right */
                padding-left: 50%; /* Make space for the data-label */
                position: relative; /* For positioning the data-label */
                border-bottom: 1px dotted #E0BBE4; /* Dotted separator between cells */
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            .overflow-x-auto table td:last-child {
                border-bottom: 0; /* No border on the last cell */
            }

            .overflow-x-auto table td::before {
                content: attr(data-label); /* Display the data-label */
                position: absolute;
                left: 0.5rem; /* Position of the label */
                width: 45%; /* Width for the label */
                padding-right: 10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: bold;
                text-align: left;
                color: #6A5ACD; /* Label color */
            }

            /* Specific adjustments for the "Actions" column in orders table */
            #ordersTable td:last-child {
                text-align: center; /* Center the button */
                padding-left: 0.5rem; /* Remove left padding for button */
            }
            #ordersTable td:last-child::before {
                display: none; /* Hide label for actions column */
            }

            /* Adjust filter layout for mobile */
            .mb-4.flex.items-center.justify-center {
                flex-direction: column; /* Stack filter elements vertically */
                align-items: flex-start; /* Align to start */
                padding: 0 10px; /* Add some horizontal padding */
            }
            .mb-4.flex.items-center.justify-center label {
                margin-bottom: 5px; /* Space between label and input */
                margin-right: 0; /* Remove right margin */
                width: 100%; /* Label takes full width */
            }
            .mb-4.flex.items-center.justify-center input,
            .mb-4.flex.items-center.justify-center select {
                width: 100%; /* Full width for inputs/selects */
                max-width: none; /* Remove max-width constraint */
                margin-bottom: 10px; /* Space between filter elements */
            }
            .mb-4.flex.items-center.justify-center.space-x-4 {
                flex-direction: column;
                align-items: flex-start;
                space-x: 0; /* Remove horizontal space */
                width: 100%;
            }
            .mb-4.flex.items-center.justify-center.space-x-4 > div {
                width: 100%;
                margin-bottom: 10px; /* Space between month/year filters */
            }
            .mb-4.flex.items-center.justify-center.space-x-4 > div:last-child {
                margin-bottom: 0;
            }

            /* Mobile adjustments for details/summary */
            details {
                margin-bottom: 0.75rem;
                border-radius: 0.75rem;
            }
            summary {
                padding: 0.75rem 2rem;
                font-size: 1rem;
            }
            details .table-container {
                padding: 0.25rem;
            }
            details table tbody tr {
                margin-bottom: 0.5rem; /* Smaller margin between rows inside details */
            }

            /* Specific mobile styling for overall financial summary table cells */
            #overallFinancialSummaryTable td {
                text-align: right; /* Align content to the right */
                padding-left: 50%; /* Make space for the data-label */
                position: relative; /* For positioning the data-label */
                border-bottom: 1px dotted #E0BBE4; /* Dotted separator between cells */
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

            #overallFinancialSummaryTable td::before {
                /* Re-enable the data-label for these specific cells on mobile */
                content: attr(data-label); /* Display the data-label */
                position: absolute;
                left: 0.5rem; /* Position of the label */
                width: 45%; /* Width for the label */
                padding-right: 10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                font-weight: bold;
                text-align: left;
                color: #6A5ACD; /* Label color */
                display: block; /* Ensure it's displayed */
            }
        }
    </style>
</head>
<body class="min-h-screen" style="font-family: 'Comic Sans MS', 'Marker Felt', 'Comic Neue', arial;">
    <!-- Floating background elements - now only emojis, more scattered and themed -->
    <div class="floating-element"><span style="font-size: 3.5em; color: #DDA0DD;">ğŸ©</span></div>
    <div class="floating-element"><span style="font-size: 3em; color: #BA55D3;">ğŸ¦</span></div>
    <div class="floating-element"><span style="font-size: 4em; color: #9370DB;">ğŸ­</span></div>
    <div class="floating-element"><span style="font-size: 2.5em; color: #E0BBE4;">ğŸ¬</span></div>
    <div class="floating-element"><span style="font-size: 3.2em; color: #FFD1DC;">ğŸŒˆ</span></div>
    <div class="floating-element"><span style="font-size: 3.8em; color: #DDA0DD;">âœ¨</span></div>
    <div class="floating-element"><span style="font-size: 3em; color: #BA55D3;">ğŸ’–</span></div>
    <div class="floating-element"><span style="font-size: 2.8em; color: #9370DB;">ğŸŒŸ</span></div>
    <div class="floating-element"><span style="font-size: 3.5em; color: #E0BBE4;">ğŸ’œ</span></div>
    <div class="floating-element"><span style="font-size: 2.5em; color: #FFD1DC;">ğŸ’™</span></div>
    <div class="floating-element"><span style="font-size: 3.7em; color: #DDA0DD;">ğŸŒ¸</span></div>
    <div class="floating-element"><span style="font-size: 3.1em; color: #BA55D3;">ğŸ’«</span></div>
    <div class="floating-element"><span style="font-size: 4.2em; color: #9370DB;">ğŸ©</span></div>
    <div class="floating-element"><span style="font-size: 2.7em; color: #E0BBE4;">ğŸ¦</span></div>
    <div class="floating-element"><span style="font-size: 3.3em; color: #FFD1DC;">ğŸ­</span></div>
    <div class="floating-element"><span style="font-size: 3.0em; color: #DDA0DD;">ğŸ¬</span></div>
    <div class="floating-element"><span style="font-size: 3.6em; color: #BA55D3;">ğŸŒˆ</span></div>
    <div class="floating-element"><span style="font-size: 2.9em; color: #9370DB;">âœ¨</span></div>
    <div class="floating-element"><span style="font-size: 4.1em; color: #E0BBE4;">ğŸ’–</span></div>
    <div class="floating-element"><span style="font-size: 3.4em; color: #FFD1DC;">ğŸŒŸ</span></div>


    <div class="donut-bg py-6 px-3 sm:py-10 sm:px-4 relative z-10 max-w-4xl mx-auto">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-10">
                <h1 class="text-3xl sm:text-5xl md:text-7xl font-bold mb-2 kid-friendly-header" style="white-space: nowrap;">ğŸ© MINI DONUT! ğŸ©</h1>
                <p class="text-lg sm:text-xl md:text-3xl text-purple-500 tracking-wide font-bold" style="font-style: italic;">ğŸŒˆ Count your donuts like a shopping spree! ğŸŒˆ</p>
            </div>
            
            <!-- Order Form -->
            <div class="bg-form-background rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-accent-pink mb-6 text-center">âœ¨ Add New Sweet Treat âœ¨</h2>
                
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3">
                    <!-- Flavor Selection -->
                    <div class="donut-card bg-card-light-pink p-4 relative">
                        <label class="block text-secondary-text font-bold mb-2">Flavor</label>
                        <select id="flavor" class="w-full p-1 md:p-2 rounded-lg border-2 md:border-4 border-input focus:border-purple-500 focus:outline-none font-bold">
                            <option value="">Select Flavor</option>
                            <option value="Chocolate">Chocolate</option>
                            <option value="White Chocolate">White Chocolate</option>
                            <option value="Ube">Ube</option>
                            <option value="Matcha">Matcha</option>
                            <option value="Strawberry">Strawberry</option>
                        </select>
                    </div>
                    
                    <!-- Topping Selection -->
                    <div class="donut-card bg-card-light-purple p-4 relative">
                        <label class="block text-accent-pink font-bold mb-2">Topping</label>
                        <select id="topping" class="w-full p-2 rounded-lg border-2 border-input focus:border-purple-500 focus:outline-none">
                            <option value="">Select Topping</option>
                            <option value="Sprinkles">Sprinkles</option>
                            <option value="Mallows">Mallows</option>
                            <option value="Crushed Oreo">Crushed Oreo</option>
                            <option value="Nips">Nips</option>
                            <option value="Kisses">Kisses</option>
                        </select>
                    </div>
                    
                    <!-- Quantity Selection -->
                    <div class="donut-card bg-card-light-yellow p-4 relative">
                        <label class="block text-accent-orange font-bold mb-2">Quantity</label>
                        <select id="quantity" class="w-full p-2 rounded-lg border-2 border-input focus:border-yellow-500 focus:outline-none">
                            <option value="">Select Quantity</option>
                            <option value="1">1 PC (â‚±7)</option>
                            <option value="2">2 PCS (â‚±14)</option>
                            <option value="3">3 PCS (â‚±20)</option>
                            <option value="4">4 PCS (â‚±28)</option>
                            <option value="5">5 PCS (â‚±35)</option>
                            <option value="6">6 PCS (â‚±40)</option>
                            <option value="7">7 PCS (â‚±49)</option>
                            <option value="8">8 PCS (â‚±56)</option>
                            <option value="9">9 PCS (â‚±63)</option>
                            <option value="10">10 PCS (â‚±70)</option>
                            <option value="11">11 PCS (â‚±77)</option>
                            <option value="12">12 PCS (â‚±84)</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="addOrder" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-full text-base md:text-xl transition duration-300 transform hover:scale-105 md:hover:scale-110 hover:shadow-lg">
                        Add to Orders ğŸ‰
                    </button>
                </div>
            </div>
            
            <!-- Orders Table -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-purple-500 mb-6 text-center">ğŸ’– Today's Orders ğŸ’–</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto" id="ordersTable">
                        <thead>
                            <tr class="bg-table-header">
                                <th class="px-4 py-2 text-left">Flavor</th>
                                <th class="px-4 py-2 text-left">Topping</th>
                                <th class="px-4 py-2 text-left">Quantity</th>
                                <th class="px-4 py-2 text-left">Price</th>
                                <th class="px-4 py-2 text-left">Date</th>
                                <th class="px-4 py-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Financial Summary -->
            <div class="grid grid-cols-1 gap-6 mb-10 lg:grid-cols-2">
                <!-- Daily Summary -->
                <div class="bg-white rounded-3xl p-6 shadow-xl">
                    <h2 class="text-3xl font-bold text-accent-pink mb-4 text-center">ğŸŒŸ Daily Summary ğŸŒŸ</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-secondary-text">Total Sales:</span>
                            <span id="totalSales" class="text-xl font-bold text-accent-pink">0 â‚±</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-secondary-text">Ingredients (60%):</span>
                            <span id="ingredientsCost" class="text-xl font-bold text-summary-green">0 â‚±</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-semibold text-secondary-text">Salary (40%):</span>
                            <span id="salaryCost" class="text-xl font-bold text-summary-blue">0 â‚±</span>
                        </div>
                    </div>
                </div>
                
                <!-- Donut Visualization -->
                <div class="bg-white rounded-3xl p-6 shadow-xl flex flex-col items-center justify-center">
                    <h2 class="text-3xl font-bold text-purple-500 mb-4 text-center">ğŸ© Today's Donuts ğŸ©</h2>
                    <div class="relative w-48 h-48">
                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/076bb821-f656-41d6-beb1-23ce63ac5abd.png" alt="Colorful assortment of mini donuts with various toppings arranged in a circle" class="w-full h-full object-contain floating" />
                    </div>
                </div>
            </div>

            <!-- History Table -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-purple-500 mb-6 text-center">ğŸ“œ Order's History ğŸ“œ</h2>
                <div class="mb-4 flex items-center justify-center">
                    <label for="historyDateFilter" class="block text-secondary-text font-bold mr-2">Filter by Date:</label>
                    <input type="date" id="historyDateFilter" class="p-2 rounded-lg border-2 border-input focus:border-purple-500 focus:outline-none">
                </div>
                <div id="historyTableContainer" class="overflow-x-auto">
                    <!-- History will be added here dynamically within details/summary -->
                </div>
            </div>

            <!-- Financial History Table (Per Order) -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-accent-pink mb-6 text-center">ğŸ’° History (Per Order) ğŸ’°</h2>
                <div class="mb-4 flex items-center justify-center">
                    <label for="financialHistoryDateFilter" class="block text-accent-pink font-bold mr-2">Filter by Date:</label>
                    <input type="date" id="financialHistoryDateFilter" class="p-2 rounded-lg border-2 border-financial-table focus:border-pink-500 focus:outline-none">
                </div>
                <div id="financialHistoryTableContainer" class="overflow-x-auto">
                    <!-- Financial history will be added here dynamically within details/summary -->
                </div>
            </div>

            <!-- Daily Financial History Table (Grand Total) -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-purple-500 mb-6 text-center">ğŸ“Š Daily History ğŸ“Š</h2>
                <div class="mb-4 flex items-center justify-center">
                    <label for="dailyFinancialHistoryDateFilter" class="block text-secondary-text font-bold mr-2">Filter by Date:</label>
                    <input type="date" id="dailyFinancialHistoryDateFilter" class="p-2 rounded-lg border-2 border-input focus:border-purple-500 focus:outline-none">
                </div>
                <div id="dailyFinancialHistoryTableContainer" class="overflow-x-auto">
                    <!-- Daily financial history will be added here dynamically within details/summary -->
                </div>
            </div>

            <!-- Monthly Financial History Table (Grand Total) - NEW SECTION -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-accent-pink mb-6 text-center">ğŸ—“ï¸ Monthly History ğŸ—“ï¸</h2>
                <div class="mb-4 flex items-center justify-center space-x-4">
                    <div>
                        <label for="monthlyFinancialMonthFilter" class="block text-accent-pink font-bold mr-2">Filter by Month:</label>
                        <select id="monthlyFinancialMonthFilter" class="p-2 rounded-lg border-2 border-financial-table focus:border-pink-500 focus:outline-none">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div>
                        <label for="monthlyFinancialYearFilter" class="block text-accent-pink font-bold mr-2">Filter by Year:</label>
                        <select id="monthlyFinancialYearFilter" class="p-2 rounded-lg border-2 border-financial-table focus:border-pink-500 focus:outline-none">
                            <option value="">All Years</option>
                            <!-- Years will be populated dynamically by JavaScript -->
                        </select>
                    </div>
                </div>
                <div id="monthlyFinancialHistoryTableContainer" class="overflow-x-auto">
                    <!-- Monthly financial history will be added here dynamically within details/summary -->
                </div>
            </div>

            <!-- Overall Financial Summary (Grand Total) -->
            <div class="bg-white rounded-3xl p-6 shadow-xl mb-10">
                <h2 class="text-3xl font-bold text-accent-pink mb-6 text-center">ğŸ“ˆ Overall Summary ğŸ“ˆ</h2>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto" id="overallFinancialSummaryTable">
                        <thead>
                            <tr class="bg-table-header">
                                <th class="px-4 py-2 text-left">Total Sales (All Time)</th>
                                <th class="px-4 py-2 text-left">Total Ingredients (60%)</th>
                                <th class="px-4 py-2 text-left">Total Salary (40%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Overall financial summary will be added here dynamically -->
                            <tr>
                                <td class="px-4 py-3 font-semibold" id="overallTotalSales" data-label="Total Sales (All Time)">0 â‚±</td>
                                <td class="px-4 py-3 text-summary-green" id="overallIngredientsCost" data-label="Total Ingredients (60%)">0 â‚±</td>
                                <td class="px-4 py-3 text-summary-blue" id="overallSalaryCost" data-label="Total Salary (40%)">0 â‚±</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase Configuration -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBapuhmZG_tLwgr3BpC_V2kpSFEpQAFntk",
        authDomain: "newmessui.firebaseapp.com",
        databaseURL: "https://newmessui-default-rtdb.firebaseio.com",
        projectId: "newmessui",
        storageBucket: "newmessui.firebasestorage.app",
        messagingSenderId: "973290499288",
        appId: "1:973290499288:web:09abf041c10188cee5bbad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let orders = [];

    // Updated priceMap to handle 7 pesos per piece, with special prices for 3 and 6
    const priceMap = {
        '1': 7,
        '2': 14,
        '3': 20, // Remains â‚±20
        '4': 28,
        '5': 35,
        '6': 40, // Remains â‚±40
        '7': 49,
        '8': 56,
        '9': 63,
        '10': 70,
        '11': 77,
        '12': 84
    };


    const flavorSelect = document.getElementById('flavor');
    const toppingSelect = document.getElementById('topping');
    const quantitySelect = document.getElementById('quantity');
    const addOrderBtn = document.getElementById('addOrder');
    const ordersTableBody = document.getElementById('ordersTableBody'); // Corrected ID
    const historyTableContainer = document.getElementById('historyTableContainer'); // Container for details/summary
    const totalSalesEl = document.getElementById('totalSales');
    const ingredientsCostEl = document.getElementById('ingredientsCost');
    const salaryCostEl = document.getElementById('salaryCost');
    const historyDateFilter = document.getElementById('historyDateFilter');
    const financialHistoryTableContainer = document.getElementById('financialHistoryTableContainer'); // Container for details/summary
    const financialHistoryDateFilter = document.getElementById('financialHistoryDateFilter');
    const dailyFinancialHistoryTableContainer = document.getElementById('dailyFinancialHistoryTableContainer'); // Container for details/summary
    const dailyFinancialHistoryDateFilter = document.getElementById('dailyFinancialHistoryDateFilter');
    const monthlyFinancialHistoryTableContainer = document.getElementById('monthlyFinancialHistoryTableContainer'); // NEW Container for details/summary
    const monthlyFinancialMonthFilter = document.getElementById('monthlyFinancialMonthFilter'); // NEW
    const monthlyFinancialYearFilter = document.getElementById('monthlyFinancialYearFilter'); // NEW
    const overallTotalSalesEl = document.getElementById('overallTotalSales'); 
    const overallIngredientsCostEl = document.getElementById('overallIngredientsCost'); 
    const overallSalaryCostEl = document.getElementById('overallSalaryCost'); 

    function getCurrentDate() {
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        return new Date().toLocaleDateString('en-PH', options);
    }

    addOrderBtn.addEventListener('click', () => {
        const flavor = flavorSelect.value;
        const topping = toppingSelect.value;
        const quantity = quantitySelect.value;
        const date = getCurrentDate(); // MM/DD/YYYY

        if (!flavor || !topping || !quantity) {
            alert('Please select all options!');
            return;
        }

        const price = priceMap[quantity]; 
        const order = { flavor, topping, quantity, price, date };

        orders.push(order);
        updateOrdersTable();
        updateFinancialSummary();
        saveOrderToFirebase(order);
        
        // Update history table with current filter or all orders
        const currentHistoryFilterDate = historyDateFilter.value;
        if (currentHistoryFilterDate) {
            const [year, month, day] = currentHistoryFilterDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateHistoryTable(formattedDate);
        } else {
            updateHistoryTable();
        }

        // Update financial history table with current filter or all orders
        const currentFinancialFilterDate = financialHistoryDateFilter.value;
        if (currentFinancialFilterDate) {
            const [year, month, day] = currentFinancialFilterDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateFinancialHistoryTable(formattedDate);
        } else {
            updateFinancialHistoryTable();
        }
        // Update daily financial history table with current filter or all orders
        const currentDailyFinancialFilterDate = dailyFinancialHistoryDateFilter.value;
        if (currentDailyFinancialFilterDate) {
            const [year, month, day] = currentDailyFinancialFilterDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateDailyFinancialHistoryTable(formattedDate);
        } else {
            updateDailyFinancialHistoryTable();
        }

        // NEW: Update monthly financial history table
        updateMonthlyFinancialHistoryTable(monthlyFinancialMonthFilter.value, monthlyFinancialYearFilter.value);
        
        updateOverallFinancialSummary(); 

        flavorSelect.value = '';
        toppingSelect.value = '';
        quantitySelect.value = '';
    });

    function saveOrderToFirebase(order) {
        const newOrderRef = ref(db, 'orders/' + Date.now());
        set(newOrderRef, order);
    }

    function loadOrdersFromFirebase() {
        console.log("Loading orders from Firebase...");
        const dbRef = ref(db);
        get(child(dbRef, 'orders')).then((snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                orders = data ? Object.values(data) : [];
                updateOrdersTable();
                updateHistoryTable(); 
                updateFinancialHistoryTable(); 
                updateDailyFinancialHistoryTable(); 
                populateYearFilter(); // NEW: Populate years on load
                updateMonthlyFinancialHistoryTable(); // NEW: Initial load of monthly table
                updateOverallFinancialSummary(); 
                updateFinancialSummary();
            } else {
                console.log("No orders found.");
            }
        }).catch((error) => {
            console.error("Error loading data:", error);
        });
    }

    function updateOrdersTable() {
        ordersTableBody.innerHTML = '';

        if (orders.length === 0) {
            ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No orders yet. Add some donuts!</td></tr>';
            return;
        }

        // Filter for today's orders only for this specific table
        const today = getCurrentDate();
        const todaysOrders = orders.filter(order => order.date === today);

        if (todaysOrders.length === 0) {
            ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No orders for today.</td></tr>';
            return;
        }

        todaysOrders.forEach((order, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b-4 border-table-row hover:bg-hover-table-row transition-all duration-200';
            row.innerHTML = `
                <td data-label="Flavor">${order.flavor}</td>
                <td data-label="Topping">${order.topping}</td>
                <td data-label="Quantity">${order.quantity} PC${order.quantity > 1 ? 'S' : ''}</td>
                <td data-label="Price" class="font-semibold">â‚±${order.price}</td>
                <td data-label="Date">${order.date}</td>
                <td data-label="Actions">
                    <button onclick="window.confirmRemove(${index})" class="remove-button">
                        âŒ Bye Bye Donut!
                    </button>
                </td>
            `;
            ordersTableBody.appendChild(row);
        });
    }

    function updateHistoryTable(filterDate = null) {
        historyTableContainer.innerHTML = ''; // Clear the container

        const filteredOrders = filterDate
            ? orders.filter(order => order.date === filterDate)
            : orders; 

        if (filteredOrders.length === 0) {
            historyTableContainer.innerHTML = '<p class="text-center py-4 text-gray-500">No orders found for this date.</p>';
            return;
        }

        // Group orders by date
        const ordersByDate = filteredOrders.reduce((acc, order) => {
            (acc[order.date] = acc[order.date] || []).push(order);
            return acc;
        }, {});

        // Sort dates in descending order (most recent first)
        const sortedDates = Object.keys(ordersByDate).sort((a, b) => {
            const dateA = new Date(a);
            const dateB = new Date(b);
            return dateB - dateA;
        });

        sortedDates.forEach(date => {
            const detailsElement = document.createElement('details');
            detailsElement.innerHTML = `<summary>${date}</summary>`;
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';

            const table = document.createElement('table');
            table.className = 'w-full table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-table-header">
                        <th class="px-4 py-2 text-left">Flavor</th>
                        <th class="px-4 py-2 text-left">Topping</th>
                        <th class="px-4 py-2 text-left">Quantity</th>
                        <th class="px-4 py-2 text-left">Price</th>
                        <th class="px-4 py-2 text-left">Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            ordersByDate[date].forEach(order => {
                const row = document.createElement('tr');
                row.className = 'border-b border-table-row hover:bg-hover-table-row';
                row.innerHTML = `
                    <td data-label="Flavor">${order.flavor}</td>
                    <td data-label="Topping">${order.topping}</td>
                    <td data-label="Quantity">${order.quantity} PC${order.quantity > 1 ? 'S' : ''}</td>
                    <td data-label="Price" class="font-semibold">â‚±${order.price}</td>
                    <td data-label="Date">${order.date}</td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            detailsElement.appendChild(tableContainer);
            historyTableContainer.appendChild(detailsElement);
        });
    }

    function updateFinancialHistoryTable(filterDate = null) {
        financialHistoryTableContainer.innerHTML = ''; // Clear the container

        const filteredOrders = filterDate
            ? orders.filter(order => order.date === filterDate)
            : orders; 

        if (filteredOrders.length === 0) {
            financialHistoryTableContainer.innerHTML = '<p class="text-center py-4 text-gray-500">No financial data found for this date.</p>';
            return;
        }

        // Group orders by date
        const ordersByDate = filteredOrders.reduce((acc, order) => {
            (acc[order.date] = acc[order.date] || []).push(order);
            return acc;
        }, {});

        // Sort dates in descending order (most recent first)
        const sortedDates = Object.keys(ordersByDate).sort((a, b) => {
            const dateA = new Date(a);
            const dateB = new Date(b);
            return dateB - dateA;
        });

        sortedDates.forEach(date => {
            const detailsElement = document.createElement('details');
            detailsElement.innerHTML = `<summary>${date}</summary>`;
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';

            const table = document.createElement('table');
            table.className = 'w-full table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-table-header">
                        <th class="px-4 py-2 text-left">Date</th>
                        <th class="px-4 py-2 text-left">Flavor</th>
                        <th class="px-4 py-2 text-left">Topping</th>
                        <th class="px-4 py-2 text-left">Quantity</th>
                        <th class="px-4 py-2 text-left">Total Price</th>
                        <th class="px-4 py-2 text-left">Ingredients (60%)</th>
                        <th class="px-4 py-2 text-left">Salary (40%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            ordersByDate[date].forEach(order => {
                const ingredientsCost = order.price * 0.6;
                const salaryCost = order.price * 0.4;
                const row = document.createElement('tr');
                row.className = 'border-b border-financial-table hover:bg-hover-financial-table';
                row.innerHTML = `
                    <td data-label="Date">${order.date}</td>
                    <td data-label="Flavor">${order.flavor}</td>
                    <td data-label="Topping">${order.topping}</td>
                    <td data-label="Quantity">${order.quantity} PC${order.quantity > 1 ? 'S' : ''}</td>
                    <td data-label="Total Price" class="font-semibold">â‚±${order.price}</td>
                    <td data-label="Ingredients (60%)" class="text-summary-green">â‚±${ingredientsCost.toFixed(2)}</td>
                    <td data-label="Salary (40%)" class="text-summary-blue">â‚±${salaryCost.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            tableContainer.appendChild(table);
            detailsElement.appendChild(tableContainer);
            financialHistoryTableContainer.appendChild(detailsElement);
        });
    }

    function updateDailyFinancialHistoryTable(filterDate = null) {
        dailyFinancialHistoryTableContainer.innerHTML = ''; // Clear the container

        // Group orders by date
        const dailySummary = orders.reduce((acc, order) => {
            if (!acc[order.date]) {
                acc[order.date] = { totalSales: 0, ingredientsCost: 0, salaryCost: 0, totalQuantity: 0 };
            }
            acc[order.date].totalSales += order.price;
            acc[order.date].ingredientsCost += (order.price * 0.6);
            acc[order.date].salaryCost += (order.price * 0.4);
            acc[order.date].totalQuantity += parseInt(order.quantity);
            return acc;
        }, {});

        let datesToDisplay = Object.keys(dailySummary);

        // Apply filter if provided
        if (filterDate) {
            datesToDisplay = datesToDisplay.filter(date => date === filterDate);
        }

        // Sort dates in descending order (most recent first)
        datesToDisplay.sort((a, b) => {
            const dateA = new Date(a);
            const dateB = new Date(b);
            return dateB - dateA;
        });

        if (datesToDisplay.length === 0) {
            dailyFinancialHistoryTableContainer.innerHTML = '<p class="text-center py-4 text-gray-500">No daily financial data available for this date.</p>';
            return;
        }

        // For daily financial history, each date is a summary, so we'll put the single row inside a details element
        datesToDisplay.forEach(date => {
            const summaryData = dailySummary[date];
            const detailsElement = document.createElement('details');
            detailsElement.innerHTML = `<summary>${date} - Total Sales: â‚±${summaryData.totalSales}</summary>`;
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';

            const table = document.createElement('table');
            table.className = 'w-full table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-table-header">
                        <th class="px-4 py-2 text-left">Date</th>
                        <th class="px-4 py-2 text-left">Total Quantity</th>
                        <th class="px-4 py-2 text-left">Total Sales</th>
                        <th class="px-4 py-2 text-left">Ingredients (60%)</th>
                        <th class="px-4 py-2 text-left">Salary (40%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            const row = document.createElement('tr');
            row.className = 'border-b border-table-row hover:bg-hover-table-row';
            row.innerHTML = `
                <td data-label="Date">${date}</td>
                <td data-label="Total Quantity">${summaryData.totalQuantity} PCS</td>
                <td data-label="Total Sales" class="font-semibold">â‚±${summaryData.totalSales}</td>
                <td data-label="Ingredients (60%)" class="text-summary-green">â‚±${summaryData.ingredientsCost.toFixed(2)}</td>
                <td data-label="Salary (40%)" class="text-summary-blue">â‚±${summaryData.salaryCost.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
            
            tableContainer.appendChild(table);
            detailsElement.appendChild(tableContainer);
            dailyFinancialHistoryTableContainer.appendChild(detailsElement);
        });
    }

    // NEW FUNCTION: Update Monthly Financial History Table
    function updateMonthlyFinancialHistoryTable(filterMonth = null, filterYear = null) {
        monthlyFinancialHistoryTableContainer.innerHTML = ''; // Clear the container

        // Group orders by Month/Year
        const monthlySummary = orders.reduce((acc, order) => {
            const [month, day, year] = order.date.split('/');
            const monthYearKey = `${month}/${year}`; // e.g., "01/2023"

            if (!acc[monthYearKey]) {
                acc[monthYearKey] = { totalSales: 0, ingredientsCost: 0, salaryCost: 0 };
            }
            acc[monthYearKey].totalSales += order.price;
            acc[monthYearKey].ingredientsCost += (order.price * 0.6);
            acc[monthYearKey].salaryCost += (order.price * 0.4);
            return acc;
        }, {});

        let monthYearKeysToDisplay = Object.keys(monthlySummary);

        // Apply filters if provided
        if (filterMonth) {
            monthYearKeysToDisplay = monthYearKeysToDisplay.filter(key => key.startsWith(`${filterMonth}/`));
        }
        if (filterYear) {
            monthYearKeysToDisplay = monthYearKeysToDisplay.filter(key => key.endsWith(`/${filterYear}`));
        }

        // Sort by year (descending) then month (descending)
        monthYearKeysToDisplay.sort((a, b) => {
            const [monthA, yearA] = a.split('/');
            const [monthB, yearB] = b.split('/');
            if (yearA !== yearB) {
                return parseInt(yearB) - parseInt(yearA);
            }
            return parseInt(monthB) - parseInt(monthA);
        });

        if (monthYearKeysToDisplay.length === 0) {
            monthlyFinancialHistoryTableContainer.innerHTML = '<p class="text-center py-4 text-gray-500">No monthly financial data available for the selected period.</p>';
            return;
        }

        monthYearKeysToDisplay.forEach(monthYearKey => {
            const summaryData = monthlySummary[monthYearKey];
            const detailsElement = document.createElement('details');
            detailsElement.innerHTML = `<summary>${monthYearKey} - Total Sales: â‚±${summaryData.totalSales}</summary>`;
            
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';

            const table = document.createElement('table');
            table.className = 'w-full table-auto';
            table.innerHTML = `
                <thead>
                    <tr class="bg-table-header">
                        <th class="px-4 py-2 text-left">Month/Year</th>
                        <th class="px-4 py-2 text-left">Total Sales</th>
                        <th class="px-4 py-2 text-left">Ingredients (60%)</th>
                        <th class="px-4 py-2 text-left">Salary (40%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            const row = document.createElement('tr');
            row.className = 'border-b border-table-row hover:bg-hover-table-row';
            row.innerHTML = `
                <td data-label="Month/Year">${monthYearKey}</td>
                <td data-label="Total Sales" class="font-semibold">â‚±${summaryData.totalSales}</td>
                <td data-label="Ingredients (60%)" class="text-summary-green">â‚±${summaryData.ingredientsCost.toFixed(2)}</td>
                <td data-label="Salary (40%)" class="text-summary-blue">â‚±${summaryData.salaryCost.toFixed(2)}</td>
            `;
            tbody.appendChild(row);
            
            tableContainer.appendChild(table);
            detailsElement.appendChild(tableContainer);
            monthlyFinancialHistoryTableContainer.appendChild(detailsElement);
        });
    }

    // NEW FUNCTION: Populate Year Filter
    function populateYearFilter() {
        const years = new Set();
        orders.forEach(order => {
            const [month, day, year] = order.date.split('/');
            years.add(year);
        });

        // Clear existing options except "All Years"
        monthlyFinancialYearFilter.innerHTML = '<option value="">All Years</option>';

        // Add years in descending order
        Array.from(years).sort((a, b) => parseInt(b) - parseInt(a)).forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            monthlyFinancialYearFilter.appendChild(option);
        });
    }


    function updateOverallFinancialSummary() {
        const totalSalesAllTime = orders.reduce((sum, order) => sum + order.price, 0);
        const ingredientsCostAllTime = totalSalesAllTime * 0.6;
        const salaryCostAllTime = totalSalesAllTime * 0.4;

        overallTotalSalesEl.textContent = `â‚±${totalSalesAllTime}`;
        overallIngredientsCostEl.textContent = `â‚±${ingredientsCostAllTime.toFixed(2)}`;
        overallSalaryCostEl.textContent = `â‚±${salaryCostAllTime.toFixed(2)}`;
    }

    // Make confirmRemove and removeOrder globally accessible
    window.confirmRemove = function(index) {
        if (confirm("Are you sure you want to say bye bye to this donut? ğŸ©")) {
            // Find the actual order to remove based on its properties, not just index in current filtered view
            // This is crucial because the 'orders' array is the source of truth, and its indices don't change with filtering.
            // However, if you're only showing today's orders in the "Today's Sweet Treats" table,
            // the index passed here is the index within that *filtered* `todaysOrders` array.
            // To correctly remove from the global `orders` array, we need to find the original index.
            
            const today = getCurrentDate();
            const todaysOrders = orders.filter(order => order.date === today);
            const orderToRemove = todaysOrders[index];

            // Find the original index in the global 'orders' array
            const originalIndex = orders.findIndex(o => 
                o.flavor === orderToRemove.flavor && 
                o.topping === orderToRemove.topping && 
                o.quantity === orderToRemove.quantity && 
                o.price === orderToRemove.price && 
                o.date === orderToRemove.date
            );

            if (originalIndex > -1) {
                orders.splice(originalIndex, 1);
                // Also remove from Firebase
                // This part requires knowing the Firebase key, which is currently `Date.now()`.
                // To properly remove from Firebase, you'd need to store the Firebase key with each order object.
                // For now, this will only remove from the local `orders` array.
                // If persistent deletion from Firebase is needed, you'd modify `saveOrderToFirebase`
                // to return the key and store it, then use `remove(ref(db, 'orders/' + key))` here.
                console.warn("Note: Deletion from Firebase is not implemented for individual orders without storing their unique Firebase keys.");
            } else {
                console.error("Order not found in global array for removal.");
            }

            updateOrdersTable();
            
            // After removing, re-apply the current history filter to all tables
            const currentHistoryFilterDate = historyDateFilter.value;
            if (currentHistoryFilterDate) {
                const [year, month, day] = currentHistoryFilterDate.split('-');
                const formattedDate = `${month}/${day}/${year}`;
                updateHistoryTable(formattedDate);
            } else {
                updateHistoryTable(); 
            }

            const currentFinancialFilterDate = financialHistoryDateFilter.value;
            if (currentFinancialFilterDate) {
                const [year, month, day] = currentFinancialFilterDate.split('-');
                const formattedDate = `${month}/${day}/${year}`;
                updateFinancialHistoryTable(formattedDate);
            } else {
                updateFinancialHistoryTable(); 
            }
            const currentDailyFinancialFilterDate = dailyFinancialHistoryDateFilter.value;
            if (currentDailyFinancialFilterDate) {
                const [year, month, day] = currentDailyFinancialFilterDate.split('-');
                const formattedDate = `${month}/${day}/${year}`;
                updateDailyFinancialHistoryTable(formattedDate);
            } else {
                updateDailyFinancialHistoryTable();
            }

            // NEW: Update monthly financial history table after removal
            updateMonthlyFinancialHistoryTable(monthlyFinancialMonthFilter.value, monthlyFinancialYearFilter.value);

            updateOverallFinancialSummary(); 
            updateFinancialSummary();
            populateYearFilter(); // Re-populate years in case the last order for a year was removed
        }
    }

    function updateFinancialSummary() {
        // Calculate summary based only on today's orders
        const today = getCurrentDate();
        const todaysOrders = orders.filter(order => order.date === today);
        const totalSales = todaysOrders.reduce((sum, order) => sum + order.price, 0);
        const ingredientsCost = totalSales * 0.6;
        const salaryCost = totalSales * 0.4;

        totalSalesEl.textContent = `â‚±${totalSales}`;
        ingredientsCostEl.textContent = `â‚±${ingredientsCost.toFixed(2)}`;
        salaryCostEl.textContent = `â‚±${salaryCost.toFixed(2)}`;
    }

    // Event listener for the general history date filter
    historyDateFilter.addEventListener('change', (event) => {
        const selectedDate = event.target.value; // Format: YYYY-MM-DD
        if (selectedDate) {
            // Convert YYYY-MM-DD to MM/DD/YYYY to match stored date format
            const [year, month, day] = selectedDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateHistoryTable(formattedDate);
        } else {
            updateHistoryTable(); 
        }
    });

    // Event listener for the financial history date filter
    financialHistoryDateFilter.addEventListener('change', (event) => {
        const selectedDate = event.target.value; // Format: YYYY-MM-DD
        if (selectedDate) {
            // Convert YYYY-MM-DD to MM/DD/YYYY to match stored date format
            const [year, month, day] = selectedDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateFinancialHistoryTable(formattedDate);
        } else {
            updateFinancialHistoryTable(); 
        }
    });

    // New Event listener for the daily financial history date filter
    dailyFinancialHistoryDateFilter.addEventListener('change', (event) => {
        const selectedDate = event.target.value; // Format: YYYY-MM-DD
        if (selectedDate) {
            // Convert YYYY-MM-DD to MM/DD/YYYY to match stored date format
            const [year, month, day] = selectedDate.split('-');
            const formattedDate = `${month}/${day}/${year}`;
            updateDailyFinancialHistoryTable(formattedDate);
        } else {
            updateDailyFinancialHistoryTable(); 
        }
    });

    // NEW: Event listeners for monthly financial history filters
    monthlyFinancialMonthFilter.addEventListener('change', () => {
        updateMonthlyFinancialHistoryTable(monthlyFinancialMonthFilter.value, monthlyFinancialYearFilter.value);
    });

    monthlyFinancialYearFilter.addEventListener('change', () => {
        updateMonthlyFinancialHistoryTable(monthlyFinancialMonthFilter.value, monthlyFinancialYearFilter.value);
    });


    // ğŸš€ Load orders on initial page load
    loadOrdersFromFirebase();

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/donut/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
</script>
</body>
</html>
